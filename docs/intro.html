<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>1 서론 | nmw: R패키지를 통해 이해하는 비선형 혼합효과 모델링</title>
  <meta name="description" content="1 서론 | nmw: R패키지를 통해 이해하는 비선형 혼합효과 모델링" />
  <meta name="generator" content="bookdown 0.19.1 and GitBook 2.6.7" />

  <meta property="og:title" content="1 서론 | nmw: R패키지를 통해 이해하는 비선형 혼합효과 모델링" />
  <meta property="og:type" content="book" />
  <meta property="og:url" content="https://book-nmw.netlify.com/" />
  <meta property="og:image" content="https://book-nmw.netlify.com/assets/cover.jpg" />
  
  <meta name="github-repo" content="asancpt/book-nmw" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="1 서론 | nmw: R패키지를 통해 이해하는 비선형 혼합효과 모델링" />
  
  
  <meta name="twitter:image" content="https://book-nmw.netlify.com/assets/cover.jpg" />

<meta name="author" content="한성필, 배균섭" />


<meta name="date" content="2020-06-18" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="index.html"/>
<link rel="next" href="method.html"/>
<script src="libs/header-attrs-2.2/header-attrs.js"></script>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />









<script src="libs/kePrint-0.0.1/kePrint.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./index.html">NONMEM estimation using R</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>책머리에</a></li>
<li class="chapter" data-level="1" data-path="intro.html"><a href="intro.html"><i class="fa fa-check"></i><b>1</b> 서론</a>
<ul>
<li class="chapter" data-level="1.1" data-path="intro.html"><a href="intro.html#maximum-likelihood-estimation"><i class="fa fa-check"></i><b>1.1</b> Maximum Likelihood Estimation</a></li>
<li class="chapter" data-level="1.2" data-path="intro.html"><a href="intro.html#이론적-배경"><i class="fa fa-check"></i><b>1.2</b> 이론적 배경</a></li>
<li class="chapter" data-level="1.3" data-path="intro.html"><a href="intro.html#first-order-conditional-estimation-foce-method"><i class="fa fa-check"></i><b>1.3</b> First-order conditional estimation (FOCE) method</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="method.html"><a href="method.html"><i class="fa fa-check"></i><b>2</b> 이론 및 계산방법</a>
<ul>
<li class="chapter" data-level="2.1" data-path="method.html"><a href="method.html#설치"><i class="fa fa-check"></i><b>2.1</b> 설치</a></li>
<li class="chapter" data-level="2.2" data-path="method.html"><a href="method.html#actual-example"><i class="fa fa-check"></i><b>2.2</b> 실제 사례</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="nonmem-document.html"><a href="nonmem-document.html"><i class="fa fa-check"></i><b>3</b> NONMEM document</a>
<ul>
<li class="chapter" data-level="3.1" data-path="nonmem-document.html"><a href="nonmem-document.html#r에서의-구현"><i class="fa fa-check"></i><b>3.1</b> R에서의 구현</a></li>
<li class="chapter" data-level="3.2" data-path="nonmem-document.html"><a href="nonmem-document.html#Theoph"><i class="fa fa-check"></i><b>3.2</b> Theophylline 예제 데이터셋</a></li>
<li class="chapter" data-level="3.3" data-path="nonmem-document.html"><a href="nonmem-document.html#고유값eigenvalue"><i class="fa fa-check"></i><b>3.3</b> 고유값(Eigenvalue)</a></li>
<li class="chapter" data-level="3.4" data-path="nonmem-document.html"><a href="nonmem-document.html#자료"><i class="fa fa-check"></i><b>3.4</b> 자료</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="result.html"><a href="result.html"><i class="fa fa-check"></i><b>4</b> 결과</a></li>
<li class="chapter" data-level="5" data-path="acknowledgement.html"><a href="acknowledgement.html"><i class="fa fa-check"></i><b>5</b> 감사의 글</a></li>
<li class="appendix"><span><b>별첨</b></span></li>
<li class="chapter" data-level="A" data-path="conclusion.html"><a href="conclusion.html"><i class="fa fa-check"></i><b>A</b> 에디슨 앱</a></li>
<li class="chapter" data-level="B" data-path="세션정보.html"><a href="세션정보.html"><i class="fa fa-check"></i><b>B</b> 세션정보</a></li>
<li class="chapter" data-level="" data-path="참고문헌.html"><a href="참고문헌.html"><i class="fa fa-check"></i>참고문헌</a></li>
<li class="divider"></li>
<li><a href="https://bookdown.org" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">nmw: R패키지를 통해 이해하는 비선형 혼합효과 모델링</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="intro" class="section level1" number="1">
<h1><span class="header-section-number">1</span> 서론</h1>
<p>비선형 혼합효과 모델링(Nonlinear mixed effect modeling)을 위해 가장 흔히 쓰이는 도구는 NONMEM®이라고 하는 소프트웨어이다. 현재 모델기반 약물개발 (Model-based drug development)를 위한 계량약리학 분야에서 가장 표준적인 도구로 생각되고 있으나 그 동작하는 원리를 이해하기는 쉽지 않다. 공개소프트웨어인 R을 통해서 NONMEM의 계산과 알고리듬을 구현하는 시도가 있었고, 성공적으로 결과값을 재현할 수 있음을 보였다. <span class="citation">(Kim, Yim, and Bae <a href="#ref-kim2015r" role="doc-biblioref">2015</a>; Bae and Yim <a href="#ref-bae2016r" role="doc-biblioref">2016</a>)</span> 이 연구를 통해서 NONMEM의 동작원리를 단계별로 실행하며 학습할 수 있게 되었다. 더 나아가 저자들은 공개 소프트웨어인 nmw R 패키지를 개발 <span class="citation">(Bae <a href="#ref-R-nmw" role="doc-biblioref">2018</a>)</span>, 배포하여 이러한 원리를 누구나 비용없이 접근할 수 있게 하였다.</p>
<p>NONMEM의 실행과정은 대체로 initialization step, estimation step(추정단계), covariance step(공분산단계), table step(표단계)으로 나눌 수 있다. 공분산단계의 목적은 추정단계에서 추정된 파라미터(θ, Ω, Σ)들의 점 추정치(point estimate)에 대한 standard error(표준오차)를 구하는 것이다. 따라서, $COV 절을 제어구문 파일에 포함시키지 않으면 표준오차 결과를 볼 수 없다. 공분산단계는 원칙적으로 추정단계가 성공했을 때만 의미가 있으므로 성공한 후에 실행되는데, 만약 추정 실패 시에도 종료시점에서의 값을 알고 싶으면 $COV에 UNCOND 옵션을 추가해주면 된다. 공분산단계가 추정단계와 별도로 분리된 이유는 NONMEM이 사용자가 준 original scale에서 목적함수를 최소화하는 것이 아니라, unconstrained parameter (UCP)를 사용하기 때문이다. UCP는 과거에 scaled and transformed parameter (STP)라고도 불리었다.</p>
<div id="maximum-likelihood-estimation" class="section level2" number="1.1">
<h2><span class="header-section-number">1.1</span> Maximum Likelihood Estimation</h2>
<p>우도함수를 최대화하면서 모수를 추정하는 방법입니다.
관측된 표본에 기초하여 관측 불가능한 파라미터(모수)를 추정하는 방법론 중 하나로, 표본들로부터 알려지지 않은 모집단 확률분포의 형태를 추정해가는 방법론입니다. (An estimation method that finds a combination of parameters which maximizes the likelihood of an observation dataset)</p>
<p>MLE는 주어진 Dataset(관측결과, D)의 발생 가능성(Likelihood, 우도)이 가장 높은 모수를 추정하고, 이를 바탕으로 최적의 f를 도출합니다. 이를 수식으로 표현하면 다음과 같습니다.</p>
<p>정규분포의 경우 n<sub>i</sub>개의 관찰값을 갖는 대상 i에 대해서 -2 log likelihood (-2LL)은 다음과 같이 표현할 수 있습니다.</p>
<p><span class="math display">\[
-2LL_i = n_i \cdot log(2\pi) + \sum\limits_{j=1}^{n_i} log(\sigma_{ij}^2) + \sum\limits_{j=1}^{n_i} \frac{(y_{ij} - \mu_{ij})^2}{\sigma_{ij}^2}
\]</span></p>
<p>위 함수를 최소화 (우도를 최대화) 하는 모수의 조합은 무엇일까요? 그 결과가 maximum likelihood estimator/estimate (MLE)이고 그 목적함수는 다음과 같습니다.</p>
<p><span class="math display">\[
O_i = \sum\limits_{j=1}^{n_i} log(\sigma_{ij}^2) + \sum\limits_{j=1}^{n_i} \frac{(y_{ij} - \mu_{ij})^2}{\sigma_{ij}^2}
\]</span></p>
<p>MLE의 장점은 매우 직관적이라는 점입니다. 그리고 별다른 가정을 하지 않고 주어진 관측결과를 바탕으로 쉽계 계산할 수 있습니다. (물론, 관측결과가 이항분포를 따를 것이라는 가정이 들어갔지만, 다른 추정법에 비해서는 가정이 약한 편입니다.)</p>
<p>MLE는 빈도론을 기반으로 합니다. 관측결과에 의존해서 판단하기 때문에 관측결과의 크기(관측횟수)와 질(관측결과의 정확성)에 따라서 모수 추정의 성패가 크게 좌우됩니다.</p>
</div>
<div id="이론적-배경" class="section level2" number="1.2">
<h2><span class="header-section-number">1.2</span> 이론적 배경</h2>
<p></p>
<p>NONMEM의 수행은 대체로 초기화단계, 추정단계, 공분산단계, 표단계로 나눌 수 있다. 이중 공분산단계에 대하여 설명하고자 한다. 추정단계가 끝나면 최종 파라미터 추정값이 구해진다. NONMEM에서는 Y의 분포가 정규이든 아니든 상관없이 정규분포의 가능도 함수(엄밀히는 이것을 약간 변형한 것)를 목적함수로 한다. 즉, maximum likelihood estimation (MLE) 방법을 사용한다.</p>
<p>MLE에서는 loglikelihood가 목적함수인 경우에 Fisher’s Information Matrix의 역행렬을 이용하여 추정값들의 분산-공분산 행렬과 표준오차를 구할 수 있다. 표준오차는 분산-공분산 행렬의 대각원소를 1/2승 한 것이다.</p>
<p>MLE 이론에 따르면 log likelihood (l)를 파라미터 추정값에서의 1계 편미분한 것의 제곱과 2계 편미분한 것이 부호만 반대인 같은 기대값을 가진다.
<span class="math display" id="eq:mle-theory">\[\begin{equation}
\begin{split}
  \int &amp; f(x;\theta)dx = 1 \\
  \int &amp; exp(lnf(x;\theta))dx = 1
\end{split}
\tag{1.1}
\end{equation}\]</span></p>
<p>양변을 <span class="math inline">\(\theta\)</span>에 대해 미분하면
<span class="math display" id="eq:theta-differential">\[\begin{equation}
\begin{split}
\int\left\{ \frac{\partial}{\partial\theta}lnf(x;\theta) \right\} exp(lnf(x;\theta))dx = 0 \\
E_{\theta}\left\lbrack \frac{\partial}{\partial\theta}lnf(X;\theta) \right\rbrack = 0
\end{split}
\tag{1.2}
\end{equation}\]</span></p>
<p>한 번 더 미분하면</p>
<p><span class="math display" id="eq:diff-diff">\[\begin{equation}
\begin{split}
\int{\frac{\partial^{2}}{\partial\theta^{2}}lnf(x;\theta) + \lbrack \frac{\partial}{\partial\theta}lnf(x;\theta) \rbrack^{2} } exp(lnf(x;\theta))dx = 0 \\
E_{\theta}\left\{ \frac{\partial^{2}}{\partial\theta^{2}}lnf(X;\theta) + \left\lbrack \frac{\partial}{\partial\theta}lnf(X;\theta) \right\rbrack^{2} \right\} = 0 \\
I(\theta) = E_{\theta}\left\{ \frac{\partial^{2}}{\partial\theta^{2}}lnf(X;\theta) \right\} = E_{\theta}\left\{ - \left\lbrack \frac{\partial}{\partial\theta}lnf(X;\theta) \right\rbrack^{2} \right\} = Var_{\theta}\left\{ \frac{\partial}{\partial\theta}lnf(X;\theta) \right\} 
\end{split}
\tag{1.3}
\end{equation}\]</span></p>
<p>좀 더 복잡한 과정을 거치면 <span class="math inline">\(\sqrt{n}({\widehat{\theta}}^{\text{MLE}} - \theta)\)</span>는 점근적으로 <span class="math inline">\(N(0,\lbrack I(\theta)\rbrack^{- 1})\)</span> 를 따름을 증명할 수 있다. <span class="citation">(김우철 <a href="#ref-kim" role="doc-biblioref">2012</a>)</span></p>
<p>아주 이상적이지만(그러나 극히 드문) 상황에서는 목적함수의 1계 미분의 제곱과 2계 미분이 같겠지만, 실제 관찰값으로 계산하면
다르다. NONMEM에서는 1계 미분의 제곱행렬을 S matrix, 2계 미분 행렬(Hessian)을 R matrix라고
부른다. 대부분의 MLE software에서는 R matrix의 inverse만으로 estimate의 분산-공분산 행렬로 삼고
표준오차를 산출한다. NONMEM에서는 <span class="math inline">\(R^{- 1}SR^{- 1}\)</span>을 estimate의 분산-공분산 행렬로 삼는다. 이것은
더 보수적인 방법이어서 신뢰구간이 더 넓게 나온다.</p>
<p>수식으로 표현하자면 다음과 같다. 여기에서 <span class="math inline">\(O_{i}\)</span>는 개인(i)의 목적함수 값이며, <span class="math inline">\(O\)</span>는 전체 목적함수 값이다.</p>
<p><span class="math display" id="eq:o-s-r">\[\begin{equation}
\begin{split}
O = \sum_{i}^{}O_{i} \\
S = \sum_{i}^{}{\nabla_{O_{i}}{\nabla_{O_{i}}}^{T}} = \sum_{i}^{}\frac{\partial O_{i}}{\partial\theta}\frac{\partial O_{i}}{\partial\theta}^{T} \\
R = \frac{\partial^{2}O}{\partial\theta^{2}}
\end{split}
\tag{1.4}
\end{equation}\]</span></p>
</div>
<div id="first-order-conditional-estimation-foce-method" class="section level2" number="1.3">
<h2><span class="header-section-number">1.3</span> First-order conditional estimation (FOCE) method</h2>
<p>FOCE는 FO 가정법보다 더 복잡합니다. EBE를 각 iteration 마다 추정하기 때문입니다.</p>
<blockquote>
<p>The FOCE is more complex than the first-order (FO) approximation method because it estimates the empirical Bayes estimate (EBE) for each iteration. By contrast, it is a further approximation of the Laplacian (LAPL) method, which uses second-order expansion terms. FOCE without INTERACTION can only be used for an additive error model, while FOCE with INTERACTION (FOCEI) can be used for any error model. The formula for FOCE without INTERACTION can be derived directly from the extension of the FO method, while the FOCE with INTERACTION method is a slight simplification of the LAPL method. Detailed formulas and R scripts are presented here for the reproduction of objective function values by NONMEM.</p>
</blockquote>

</div>
</div>
<h3>참고문헌</h3>
<div id="refs" class="references">
<div id="ref-R-nmw">
<p>Bae, Kyun-Seop. 2018. <em>Nmw: Understanding Nonlinear Mixed Effects Modeling for Population Pharmacokinetics</em>. <a href="https://CRAN.R-project.org/package=nmw">https://CRAN.R-project.org/package=nmw</a>.</p>
</div>
<div id="ref-bae2016r">
<p>Bae, Kyun-Seop, and Dong-Seok Yim. 2016. “R-Based Reproduction of the Estimation Process Hidden Behind Nonmem Part 2: First-Order Conditional Estimation.” <em>Translational and Clinical Pharmacology</em> 24 (4): 161–68.</p>
</div>
<div id="ref-kim2015r">
<p>Kim, Min-Gul, Dong-Seok Yim, and Kyun-Seop Bae. 2015. “R-Based Reproduction of the Estimation Process Hidden Behind Nonmem Part 1: First-Order Approximation Method.” <em>Translational and Clinical Pharmacology</em> 23 (1): 1–7.</p>
</div>
<div id="ref-kim">
<p>김우철. 2012. <em>수리통계학</em>. 민영사. <a href="https://books.google.co.kr/books?id=yBOWtwAACAAJ">https://books.google.co.kr/books?id=yBOWtwAACAAJ</a>.</p>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="index.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="method.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": true,
"facebook": false,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/asancpt/nmw-nonmem/edit/master/inst/examples/01.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["nmw.pdf"],
"toc": {
"collapse": "chapter"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
